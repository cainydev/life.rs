name: Release & Pages Deployment

on:
  push:
    branches:
      - "master"

env:
  CRATE_NAME: game_of_life
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build Multi-Target
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # --- Linux x86_64 ---
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            bin_name: game_of_life
            archive_name: game_of_life-linux-x64.tar.gz
            post_build_steps: "native_archive"

          # --- Windows x86_64 ---
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            bin_name: game_of_life.exe
            archive_name: game_of_life-windows-x64.zip
            post_build_steps: "native_archive"

          # --- WebAssembly (WASM) ---
          - os: ubuntu-latest
            target: wasm32-unknown-unknown
            bin_name: game_of_life.wasm
            archive_name: game_of_life-web.zip
            post_build_steps: "wasm_bindgen"

    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
          target: ${{ matrix.target }}

      - name: Cache Cargo registry and build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.target }}-

      - name: Install Linux Dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y g++ pkg-config libx11-dev libasound2-dev libudev-dev libwayland-dev libxkbcommon-dev

      - name: Build for ${{ matrix.target }}
        run: cargo build --release --target ${{ matrix.target }}

      # --- WASM Specific Steps ---
      - name: Configure and Bundle WASM
        if: matrix.post_build_steps == 'wasm_bindgen'
        run: |
          # 3. Use the Global ENV variable in scripts
          # The shell can now access the variable we defined at the top
          CRATE_NAME="${{ env.CRATE_NAME }}"

          cargo install wasm-bindgen-cli

          CRATE_BIN_PATH="./target/wasm32-unknown-unknown/release/$CRATE_NAME.wasm"
          OUT_DIR="dist"
          OUT_NAME="index"

          mkdir -p $OUT_DIR
          cp -r assets $OUT_DIR/ || true

          wasm-bindgen --no-typescript --target web \
              --out-dir $OUT_DIR \
              --out-name $OUT_NAME \
              $CRATE_BIN_PATH

          # Create index.html with the correct title
          echo "<!DOCTYPE html>
          <html>
          <head>
              <meta charset=\"utf-8\">
              <title>$CRATE_NAME</title>
              <style>
                  html, body { margin: 0; padding: 0; width: 100dvw; height: 100dvh; overflow: hidden; background-color: #000000; }
                  #bevy-canvas { display: block; width: 100%; height: 100%; }
              </style>
          </head>
          <body>
              <canvas id=\"bevy-canvas\"></canvas>
              <script src=\"index.js\"></script>
          </body>
          </html>" > $OUT_DIR/index.html

          # Use the matrix archive name for the zip
          zip -r ${{ matrix.archive_name }} $OUT_DIR

      # --- Native Specific Steps ---
      - name: Archive Native Binaries
        if: matrix.post_build_steps == 'native_archive'
        run: |
          CRATE_NAME="${{ env.CRATE_NAME }}"
          cd target/${{ matrix.target }}/release

          if [ "${{ matrix.os }}" == "windows-latest" ]; then
            7z a ${CRATE_NAME}-windows-x64.zip ${CRATE_NAME}.exe
          else
            tar -czvf ${CRATE_NAME}-linux-x64.tar.gz ${CRATE_NAME}
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.archive_name }}
          path: ${{ matrix.archive_name }}

  # --- 2. PAGES DEPLOYMENT JOB ---
  deploy-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [build]

    steps:
      - name: Download WASM artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.CRATE_NAME }}-web.zip
          path: ./

      - name: Unzip WASM files
        run: |
          unzip ${{ env.CRATE_NAME }}-web.zip

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          publish_branch: gh-pages
